#' Simulate latent process with noise
#'
#' @param object  ngme model specified by f() function
#' @param nsim ignored
#' @param seed seed
#' @param ... ignored
#'
#' @return a realization of latent model
#' @export
#'
#' @examples
#' simulate(f(1:10, model="ar1", rho = 0.4, noise = noise_nig()))
#' simulate(f(rnorm(10), model="rw1", noise = noise_normal()))
simulate.ngme_model <- function(
    object,
    nsim   = NULL,
    seed   = NULL,
    ...
) {
    model <- object
    noise <- model$noise

    # simulate noise
    h <- model$operator$h
    mu    <- as.numeric(noise$B_mu %*% noise$theta_mu)
    sigma <- as.numeric(exp(noise$B_sigma %*% noise$theta_sigma))
    nu <- noise$nu
    n <- length(mu)

    if (length(noise$noise_type) == 2) {
        # bivariate noise
        e1 <- simulate_noise(noise$noise_type[[1]],
          head(h, n/2), head(mu, n/2), head(sigma, n/2), nu[[1]], rnorm(1), noise$single_V)
        if (noise$share_V) e2 <- e1
        else e2 <- simulate_noise(noise$noise_type[[2]],
            tail(h, n/2), tail(mu, n/2), tail(sigma, n/2), nu[[2]], rnorm(1), noise$single_V)
        e <- c(e1, e2);
        attr(e, "V") <- c(attr(e1, "V"), attr(e2, "V"))
    } else {
        e <- simulate_noise(noise$noise_type, h, mu, sigma, nu, rnorm(1), noise$single_V)
    }
    W <- as.numeric(solve(model$operator$K, e))

    # attach noise attributes
    attr(W, "noise") <- noise
    attr(W, "V") <- attr(e, "V")

    # make it mean 0
    # W
    W - mean(W)
}

simulate_noise <- function(
    noise_type, h_vec, mu_vec, sigma_vec, nu, seed, single_V
) {
    stopifnot(
        length(mu_vec) == length(sigma_vec),
        length(mu_vec) == length(h_vec)
    )
    n <- length(mu_vec)

    if (noise_type == "normal") {
        V <- h_vec
    } else if (noise_type == "nig" || noise_type == "normal_nig") {
        V <- if (single_V) h_vec * ngme2::rig(1, a=nu, b=nu, seed=seed)
            else ngme2::rig(n, a=nu, b=nu * (h_vec)^2, seed = seed)
    } else if (noise_type == "gal") {
        V <- if (single_V) h_vec * rgamma(1, nu, nu)
            else rgamma(n, shape = h_vec * nu, rate = nu)
    } else {
        stop("unknown noise to simulate")
    }

    e <- mu_vec * (V - h_vec) + sigma_vec * sqrt(V) * rnorm(n)
    attr(e, "V") <- V
    e
}

#' Simulate ngme noise object
#'
#' @param object  ngme noise object
#' @param h should be of same length as nsim
#' @param seed seed
#' @param nsim ignored
#' @param ... ignored
#'
#' @return a realization of noise
#' @export
simulate.ngme_noise <- function(
    object,
    nsim = NULL,
    seed = NULL,
    h = NULL,
    ...
) {
    n_noise <- max(nrow(object$B_mu), nrow(object$B_sigma))
    if (is.null(seed)) seed <- Sys.time()
    if (is.null(h)) h <- rep(1, n_noise)
    if (length(h) > n_noise) n_noise <- length(h)
    stopifnot(length(h) == n_noise)

    with(object, {
        mu_vec    <- as.numeric(B_mu %*% theta_mu)
        sigma_vec <- as.numeric(exp(B_sigma %*% theta_sigma))
        if (length(mu_vec) == 1) mu_vec <- rep(mu_vec, n_noise)
        if (length(sigma_vec) == 1) sigma_vec <- rep(sigma_vec, n_noise)

        simulate_noise(noise_type, h, mu_vec, sigma_vec, nu, seed, single_V)
    })
}


