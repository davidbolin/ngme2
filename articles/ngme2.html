<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ngme2 - A new Flexible R Package for Latent non-Gaussian Models • ngme2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Ngme2 - A new Flexible R Package for Latent non-Gaussian Models">
<meta property="og:description" content="ngme2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ngme2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ngme2.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Installation_and_configuration.html">Installation and configuration</a>
    </li>
    <li>
      <a href="../articles/inla_compare.html">Comparison with R-INLA</a>
    </li>
    <li>
      <a href="../articles/AR1-model.html">AR(1) model</a>
    </li>
    <li>
      <a href="../articles/RW-model.html">Random walk model</a>
    </li>
    <li>
      <a href="../articles/SPDE-model.html">SPDE Matern model</a>
    </li>
    <li>
      <a href="../articles/replicate.html">Ngme replicate feature</a>
    </li>
    <li>
      <a href="../articles/pred_and_est.html">Model estimation and prediction</a>
    </li>
    <li>
      <a href="../articles/bivariate.html">Bivariate models in Ngme2</a>
    </li>
    <li>
      <a href="../articles/tp-bv.html">Space-time bivariate model in Ngme2</a>
    </li>
    <li>
      <a href="../articles/random-effect.html">Random effects model in Ngme2</a>
    </li>
    <li>
      <a href="../articles/tensor_product.html">Space-time (tensor product) model in Ngme2</a>
    </li>
    <li>
      <a href="../articles/matern-on-graph.html">Matern SPDE model on Metric Graph</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/davidbolin/ngme2" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/jdavidbolin" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Ngme2 - A new Flexible R Package for Latent
non-Gaussian Models</h1>
            
            <h4 data-toc-skip class="date">2024-04-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/davidbolin/ngme2/blob/HEAD/vignettes/ngme2.Rmd" class="external-link"><code>vignettes/ngme2.Rmd</code></a></small>
      <div class="hidden name"><code>ngme2.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we provide a brief introduction to the
<code>ngme2</code> package.</p>
<p><code>Ngme2</code> (<a href="https://github.com/davidbolin/ngme2" class="external-link uri">https://github.com/davidbolin/ngme2</a>) is the updated
version of <code>Ngme</code>, a package for estimating latent
non-Gaussian models for repeated measurement data. <code>Ngme2</code>
follows a hierachical structure, differnet components (latent processes,
different types of noises) are flexible to change and combine.</p>
<div class="section level3">
<h3 id="features">1 Features<a class="anchor" aria-label="anchor" href="#features"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Support temporal models like <strong>AR(1)</strong>,
<strong>Ornstein−Uhlenbeck</strong> and <strong>random walk</strong>
processes, and spatial models like <strong>Matern</strong> fields.</li>
<li>Support latent processes constructed by <strong>non-Gaussian
noises</strong> (normal inverse Gaussian(NIG), generalized asymmetric
Laplace (GAL)).</li>
<li>Support non-Gaussian, and correlated <strong>measurement
noises</strong>.</li>
<li>Support doing <strong>prediction</strong> at unknown locations.</li>
<li>Support latent processes and random-effects model for
<strong>longitudinal data</strong>.</li>
<li>Support the bivariate type-G model, which can model 2 non-Gaussian
fields jointly (Bolin 2020).</li>
<li>Support the separable space-time model.</li>
</ol>
</div>
<div class="section level3">
<h3 id="model-framework">2 Model Framework<a class="anchor" aria-label="anchor" href="#model-framework"></a>
</h3>
<p>The package <code>Ngme2</code> provides methods for mixed effect
models in the following form:</p>
<p><span class="math display">\[
{\bf Y}_{ij} = {\bf X}^T_{ij} {\bf \beta} + {\bf D}^T_{ij} {\bf U}_i +
W_i(t_{ij}) + \epsilon_{ij},
\qquad j=1 \ldots n_i, i=1,\ldots,m
\]</span></p>
<ul>
<li>
<span class="math inline">\(m\)</span> is the number of subjects,
<span class="math inline">\(n_i\)</span> is the number of observations
for each subject,</li>
<li>
<span class="math inline">\(Y\)</span> is the response
variable,</li>
<li>
<span class="math inline">\({\bf X}\)</span> is the matrix of fixed
effects explanatory variables,</li>
<li>
<span class="math inline">\({\bf \beta}\)</span> is the fixed
effects,</li>
<li>
<span class="math inline">\({\bf D}\)</span> is the matrix of random
effects explanatory variables,</li>
<li>
<span class="math inline">\(\bf U\)</span> is the random
effects,</li>
<li>
<span class="math inline">\(W_i(t_{ij})\)</span> is a stochastic
process driven by Gaussian or non-Gaussian noise,</li>
<li>
<span class="math inline">\(\epsilon\)</span> is measurement
error.</li>
</ul>
<p>Here is a simple template for using the core function
<code>ngme</code> to model the single response:</p>
<pre><code><span><span class="fu"><a href="../reference/ngme.html">ngme</a></span><span class="op">(</span></span>
<span>  formula<span class="op">=</span><span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span><span class="va">index</span>, model<span class="op">=</span><span class="st">"ar"</span>, noise<span class="op">=</span><span class="st">"nig"</span><span class="op">)</span>,</span>
<span>  data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, x1<span class="op">=</span><span class="va">x1</span>, x2<span class="op">=</span><span class="va">x2</span>, index<span class="op">=</span><span class="va">index</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu"><a href="../reference/ngme_noise.html">noise_normal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p>Here, function <code>f</code> is for modeling the stochastic process
W with Gaussian or non-Gaussian noise, we will discuss this later.
<code>noise</code> stands for the measurement noise distribution. In
this case, the model will have a Gaussian likelihood.</p>
</div>
<div class="section level3">
<h3 id="non-gaussian-model">3 Non-Gaussian Model<a class="anchor" aria-label="anchor" href="#non-gaussian-model"></a>
</h3>
<p>Here we assume the non-Gaussian process is a type-G Lévy process,
whose increments can be represented as location-scale mixtures: <span class="math display">\[\gamma + \mu V + \sigma \sqrt{V}Z,\]</span> where
<span class="math inline">\(\gamma, \mu, \sigma\)</span> are parameters,
<span class="math inline">\(Z\sim N(0,1)\)</span> and is independent of
<span class="math inline">\(V\)</span>, and <span class="math inline">\(V\)</span> is a positive infinitely divisible
random variable. It results in the following form, where <span class="math inline">\(K\)</span> is the operator part:</p>
<p><span class="math display">\[
KW|V \sim N(\gamma + \mu V, \sigma^2 \, diag(V)),
\]</span> also, <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> can be non-stationary.</p>
<p>One example in <code>Ngme2</code> is the normal inverse Gaussian
(NIG) noise, in this case, <span class="math inline">\(V\)</span>
follows Inverse Gaussian distribution with parameter <span class="math inline">\(\nu\)</span> (IG(<span class="math inline">\(\nu\)</span>, <span class="math inline">\(\nu\)</span>)). See <code><a href="../reference/nig.html">?nig</a></code> for more
details.</p>
</div>
<div class="section level3">
<h3 id="parameter-estimation">4 Parameter Estimation<a class="anchor" aria-label="anchor" href="#parameter-estimation"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Ngme2 does maximum likelihood estimation through preconditioned
stochastic gradient descent.</li>
<li>Multiple chains are run in parallel for better convergence
checks.</li>
</ol>
<p>See <a href="pred_and_est.html">Model estimation and prediction</a>
for more details.</p>
</div>
</div>
<div class="section level2">
<h2 id="ngme-model-structure">Ngme Model Structure<a class="anchor" aria-label="anchor" href="#ngme-model-structure"></a>
</h2>
<div class="section level3">
<h3 id="specify-the-driven-noise">Specify the driven noise<a class="anchor" aria-label="anchor" href="#specify-the-driven-noise"></a>
</h3>
<p>There are 2 types of common noise involved in the model, one is the
innovation noise of a stochastic process, one is the measurement noise
of the observations. They can be both specified by
<code>noise_&lt;type&gt;</code> function.</p>
<p>For now we support <strong>normal</strong>, <strong>NIG</strong>, and
<strong>GAL</strong> noises.</p>
<p>The R class <code>ngme_noise</code> has the following interface:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inlabru-org.github.io/fmesher/" class="external-link">fmesher</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.maths.lancs.ac.uk/~rowlings/Splancs/" class="external-link">splancs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidbolin.github.io/ngme2/">ngme2</a></span><span class="op">)</span></span>
<span><span class="co"># load_all()</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ngme_noise.html">noise_normal</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>              <span class="co"># normal noise</span></span>
<span><span class="co">#&gt; Noise type: NORMAL</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     sigma = 1</span></span>
<span><span class="fu"><a href="../reference/ngme_noise.html">noise_nig</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="fl">2</span>, nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># nig noise</span></span>
<span><span class="co">#&gt; Noise type: NIG</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     mu = 1</span></span>
<span><span class="co">#&gt;     sigma = 2</span></span>
<span><span class="co">#&gt;     nu = 1</span></span>
<span><span class="fu"><a href="../reference/ngme_noise.html">noise_nig</a></span><span class="op">(</span>            <span class="co"># non-stationary nig noise</span></span>
<span>  B_mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  theta_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  B_sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  theta_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>  nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Noise type: NIG</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     theta_mu = 1, 2</span></span>
<span><span class="co">#&gt;     theta_sigma = 1, 2</span></span>
<span><span class="co">#&gt;     nu = 1</span></span></code></pre></div>
<!-- to-do, plot some nig noise -->
<p>The 3rd example is the non-stationary NIG noise, where <span class="math inline">\(\mu = \bf B_{\mu} \bf \theta_{\mu}\)</span>, and
<span class="math inline">\(\sigma = \exp(\bf B_{\sigma} \bf
\theta_{\sigma})\)</span>.</p>
<pre><code><span><span class="fu"><a href="../reference/ngme_noise.html">ngme_noise</a></span><span class="op">(</span></span>
<span>  <span class="va">type</span>,           <span class="co"># the type of noise</span></span>
<span>  <span class="va">theta_mu</span>,       <span class="co"># mu parameter</span></span>
<span>  <span class="va">theta_sigma</span>,    <span class="co"># sigma parameter</span></span>
<span>  <span class="va">nu</span>,        <span class="co"># nu parameter</span></span>
<span>  <span class="va">B_mu</span>,           <span class="co"># basis matrix for non-stationary mu</span></span>
<span>  <span class="va">B_sigma</span>         <span class="co"># basis matrix for non-stationary sigma</span></span>
<span><span class="op">)</span></span></code></pre>
<p>It will construct the following noise structure:</p>
<p><span class="math display">\[
  - \mathbf{\mu} + \mathbf{\mu} V + \mathbf{\sigma} \sqrt{V} Z
\]</span></p>
<p>where <span class="math inline">\(\mu = \bf B_{\mu} \bf
\theta_{\mu}\)</span>, and <span class="math inline">\(\sigma = \exp(\bf
B_{\sigma} \bf \theta_{\sigma})\)</span>. In this case, we can recover
gaussian noise by setting <strong>type=“normal</strong> and ignoring
<strong>theta_mu</strong> and <strong>nu</strong>. Or we can simply use
helper function <code>noise_normal(sd=1)</code></p>
</div>
<div class="section level3">
<h3 id="specify-stochastic-process-with-f-function">Specify stochastic process with <code>f</code> function<a class="anchor" aria-label="anchor" href="#specify-stochastic-process-with-f-function"></a>
</h3>
<p>The middle layer is the stochastic process, in R interface, it is
represented as a <code>f</code> function. The process can be specified
by different noise structure. See <code>?ngme_model_types()</code> for
more details.</p>
<p>Some examples of using <code>f</code> function to specify
<code>ngme_model</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ngme2</span><span class="fu">::</span><span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, model <span class="op">=</span> <span class="st">"ar1"</span>, noise <span class="op">=</span> <span class="fu"><a href="../reference/ngme_noise.html">noise_nig</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model type: AR(1)</span></span>
<span><span class="co">#&gt;     rho = 0</span></span>
<span><span class="co">#&gt; Noise type: NIG</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     mu = 0</span></span>
<span><span class="co">#&gt;     sigma = 1</span></span>
<span><span class="co">#&gt;     nu = 1</span></span></code></pre></div>
<p>One useful model would be the SPDE model with Gaussian or
non-Gaussian noise, see the vignette for details.</p>
</div>
<div class="section level3">
<h3 id="specifying-latent-models-with-formula-in-ngme">Specifying latent models with formula in <code>ngme</code><a class="anchor" aria-label="anchor" href="#specifying-latent-models-with-formula-in-ngme"></a>
</h3>
<p>The latent model can be specified additively as a
<strong>formula</strong> argument in <code>ngme</code> function together
with <strong>fixed effects</strong>.</p>
<p>We use R formula to specify the latent model. We can specify the
model using <code>f</code> within the formula.</p>
<p>For example, the following formula</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span></span>
<span>    <span class="va">x2</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>    noise <span class="op">=</span> <span class="fu"><a href="../reference/ngme_noise.html">noise_nig</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    theta_K <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"rw1"</span>,</span>
<span>    circular <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    noise <span class="op">=</span> <span class="fu"><a href="../reference/ngme_noise.html">noise_normal</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>corresponds to the model</p>
<p><span class="math display">\[
Y = \beta_0 + \beta_1 x_1 + W_1(x_2) + W_2(x_3) + \epsilon,
\]</span> where <span class="math inline">\(W_1\)</span> is an AR(1)
process, <span class="math inline">\(W_2\)</span> is a random walk 1
process. <span class="math inline">\(x_2\)</span> is random effects.. .
By default, we have intercept. The distribution of the measurement error
<span class="math inline">\(\epsilon\)</span> is given in the
<code>ngme</code> function.</p>
<p>The entire model can be fitted, along with the specification of the
distribution of the measurement error through the <code>ngme</code>
function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ngme(</span></span>
<span><span class="co">#   formula = formula,</span></span>
<span><span class="co">#   family = noise_normal(sigma = 0.5),</span></span>
<span><span class="co">#   data = data.frame(Y = 1:5, x1 = 2:6, x2 = 3:7),</span></span>
<span><span class="co">#   control_opt = control_opt(</span></span>
<span><span class="co">#     estimation = FALSE</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<p>It gives the <code>ngme</code> object, which has three parts:</p>
<ol style="list-style-type: decimal">
<li>Fixed effects (intercept and x1)</li>
<li>Measurement noise (normal noise)</li>
<li>Latent models (contains 2 models, ar1 and rw1)</li>
</ol>
<p>We can turn the <code>estimation = TRUE</code> to start estimating
the model.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-simple-example---ar1-process-with-nig-noise">A simple example - AR1 process with nig noise<a class="anchor" aria-label="anchor" href="#a-simple-example---ar1-process-with-nig-noise"></a>
</h2>
<p>Now let’s see an example of an AR1 process with nig noise. The
process is defined as</p>
<p><span class="math display">\[
W_i = \rho W_{i-1} + \epsilon_i,
\]</span> Here, <span class="math inline">\(\epsilon_1,
..,\epsilon_n\)</span> is the iid <strong>NIG</strong> noise. And, it is
easy to verify that <span class="math display">\[ K{\bf W} =
\boldsymbol\epsilon,\]</span> where <span class="math display">\[
K =
  \begin{bmatrix}
    \sqrt{1-\rho^2} \\
    -\rho &amp;  1 \\
    &amp; \ddots &amp; \ddots \\
    &amp; &amp; -\rho &amp;  1
  \end{bmatrix}
\]</span></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># n_obs &lt;- 500</span></span>
<span><span class="co"># sigma_eps &lt;- 0.5</span></span>
<span><span class="co"># alpha &lt;- 0.5</span></span>
<span><span class="co"># mu = 2; delta = -mu</span></span>
<span><span class="co"># sigma &lt;- 3</span></span>
<span><span class="co"># nu &lt;- 1</span></span>
<span></span>
<span><span class="co"># # First we generate V. V_i follows inverse Gaussian distribution</span></span>
<span><span class="co"># trueV &lt;- ngme2::rig(n_obs, nu, nu, seed = 10)</span></span>
<span></span>
<span><span class="co"># # Then generate the nig noise</span></span>
<span><span class="co"># mynoise &lt;- delta + mu*trueV + sigma * sqrt(trueV) * rnorm(n_obs)</span></span>
<span><span class="co"># trueW &lt;- Reduce(function(x,y){y + alpha*x}, mynoise, accumulate = T)</span></span>
<span><span class="co"># Y = trueW + rnorm(n_obs, mean=0, sd=sigma_eps)</span></span>
<span></span>
<span><span class="co"># # Add some fixed effects</span></span>
<span><span class="co"># x1 = runif(n_obs)</span></span>
<span><span class="co"># x2 = rexp(n_obs)</span></span>
<span><span class="co"># beta &lt;- c(-3, -1, 2)</span></span>
<span><span class="co"># X &lt;- (model.matrix(Y ~ x1 + x2))  # design matrix</span></span>
<span><span class="co"># Y = as.numeric(Y + X %*% beta)</span></span></code></pre></div>
<p>Now let’s fit the model using <code>ngme</code>. Here we can use
<code>control_opt</code> to modify the control variables for the
<code>ngme</code>. See <code><a href="../reference/control_opt.html">?control_opt</a></code> for more optioins.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # Fit the model with the AR1 model</span></span>
<span><span class="co"># ngme_out &lt;- ngme(</span></span>
<span><span class="co">#   Y ~ x1 + x2 + f(</span></span>
<span><span class="co">#     1:n_obs,</span></span>
<span><span class="co">#     name = "my_ar",</span></span>
<span><span class="co">#     model = "ar1",</span></span>
<span><span class="co">#     noise = noise_nig()</span></span>
<span><span class="co">#   ),</span></span>
<span><span class="co">#   data=data.frame(x1=x1, x2=x2, Y=Y),</span></span>
<span><span class="co">#   control_opt = control_opt(</span></span>
<span><span class="co">#     burnin = 100,</span></span>
<span><span class="co">#     iterations = 1000,</span></span>
<span><span class="co">#     std_lim = 0.4,</span></span>
<span><span class="co">#     n_parallel_chain = 4,</span></span>
<span><span class="co">#     stop_points = 10,</span></span>
<span><span class="co">#     print_check_info = FALSE,</span></span>
<span><span class="co">#     seed = 3,</span></span>
<span><span class="co">#     sampling_strategy = "ws"</span></span>
<span><span class="co">#     # verbose = T</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<p>Next we can read the result directly from the object.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ngme_out</span></span></code></pre></div>
<p>As we can see, the model converges in 350 iterations. The estimation
results are close to the real parameter.</p>
<p>We can also use the <code>traceplot</code> function to see the
estimation traceplot.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># traceplot(ngme_out, "my_ar")</span></span></code></pre></div>
<p>We can also do a density comparison with the estimated noise and the
true NIG noise:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ngme_out$replicates[[1]] means for the 1st replicate</span></span>
<span><span class="co"># plot(</span></span>
<span><span class="co">#   ngme_out$replicates[[1]]$models[[1]]$noise,</span></span>
<span><span class="co">#   noise_nig(mu = mu, sigma = sigma, nu = nu)</span></span>
<span><span class="co"># )</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="paraná-dataset">Paraná dataset<a class="anchor" aria-label="anchor" href="#paran%C3%A1-dataset"></a>
</h2>
<p>The rainfall data from Paraná (Brazil) is collected by the National
Water Agency in Brazil (Agencia Nacional de Águas, ANA, in Portuguese).
ANA collects data from many locations over Brazil, and all these data
are freely available from the ANA website (<a href="http://www3.ana.gov.br/portal/ANA" class="external-link uri">http://www3.ana.gov.br/portal/ANA</a>).</p>
<p>We will briefly illustrate the command we use, and the result of the
estimation.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(INLA)</span></span>
<span><span class="co"># data(PRprec)</span></span>
<span><span class="co"># data(PRborder)</span></span>
<span></span>
<span><span class="co"># # Create mesh</span></span>
<span><span class="co"># coords &lt;- as.matrix(PRprec[, 1:2])</span></span>
<span><span class="co"># prdomain &lt;- fmesher::fm_nonconvex_hull(coords, -0.03, -0.05, resolution = c(100, 100))</span></span>
<span><span class="co"># prmesh &lt;- fmesher::fm_mesh_2d(boundary = prdomain, max.edge = c(0.45, 1), cutoff = 0.2)</span></span>
<span></span>
<span><span class="co"># # monthly mean at each location</span></span>
<span><span class="co"># Y &lt;- rowMeans(PRprec[, 12 + 1:31]) # 2 + Octobor</span></span>
<span></span>
<span><span class="co"># ind &lt;- !is.na(Y) # non-NA index</span></span>
<span><span class="co"># Y &lt;- Y_mean &lt;- Y[ind]</span></span>
<span><span class="co"># coords &lt;- as.matrix(PRprec[ind, 1:2])</span></span>
<span><span class="co"># seaDist &lt;- apply(spDists(coords, PRborder[1034:1078, ],</span></span>
<span><span class="co">#   longlat = TRUE</span></span>
<span><span class="co"># ), 1, min)</span></span></code></pre></div>
<p>Plot the data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># out &lt;- ngme(</span></span>
<span><span class="co">#   formula = Y ~ 1 +</span></span>
<span><span class="co">#     f(seaDist, name="rw1", model = "rw1", noise = noise_normal()) +</span></span>
<span><span class="co">#     f(coords, model = "matern", mesh = prmesh, name="spde", noise = noise_normal()),</span></span>
<span><span class="co">#   data = data.frame(Y = Y),</span></span>
<span><span class="co">#   family = "nig",</span></span>
<span><span class="co">#   control_opt = control_opt(</span></span>
<span><span class="co">#     estimation = T,</span></span>
<span><span class="co">#     iterations = 1000,</span></span>
<span><span class="co">#     n_slope_check = 4,</span></span>
<span><span class="co">#     stop_points = 10,</span></span>
<span><span class="co">#     std_lim = 0.1,</span></span>
<span><span class="co">#     n_parallel_chain = 4,</span></span>
<span><span class="co">#     print_check_info = FALSE,</span></span>
<span><span class="co">#     seed = 16</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># out</span></span>
<span></span>
<span><span class="co"># # traceplots</span></span>
<span><span class="co"># ## fixed effects and measurement error</span></span>
<span><span class="co"># traceplot(out)</span></span>
<span></span>
<span><span class="co"># ## spde model</span></span>
<span><span class="co"># traceplot(out, "spde")</span></span></code></pre></div>
<p>Parameter estimation results:</p>
<div class="section level3">
<h3 id="prediction">Prediction<a class="anchor" aria-label="anchor" href="#prediction"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># nxy &lt;- c(150, 100)</span></span>
<span><span class="co"># projgrid &lt;- rSPDE::rspde.mesh.projector(prmesh,</span></span>
<span><span class="co">#   xlim = range(PRborder[, 1]),</span></span>
<span><span class="co">#   ylim = range(PRborder[, 2]), dims = nxy</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span><span class="co"># xy.in &lt;- inout(projgrid$lattice$loc, cbind(PRborder[, 1], PRborder[, 2]))</span></span>
<span></span>
<span><span class="co"># coord.prd &lt;- projgrid$lattice$loc[xy.in, ]</span></span>
<span><span class="co"># plot(coord.prd, type = "p", cex = 0.1)</span></span>
<span><span class="co"># lines(PRborder)</span></span>
<span><span class="co"># points(coords[, 1], coords[, 2], pch = 19, cex = 0.5, col = "red")</span></span>
<span></span>
<span><span class="co"># seaDist.prd &lt;- apply(spDists(coord.prd,</span></span>
<span><span class="co">#   PRborder[1034:1078, ],</span></span>
<span><span class="co">#   longlat = TRUE</span></span>
<span><span class="co"># ), 1, min)</span></span>
<span></span>
<span><span class="co"># # doing prediction by giving the predict location</span></span>
<span><span class="co"># pds &lt;- predict(out, map=list(rw1=seaDist.prd, spde=coord.prd))</span></span>
<span><span class="co"># lp &lt;- pds$mean</span></span>
<span><span class="co"># ggplot() +</span></span>
<span><span class="co">#   geom_point(aes(</span></span>
<span><span class="co">#     x = coord.prd[, 1], y = coord.prd[, 2],</span></span>
<span><span class="co">#     colour = lp</span></span>
<span><span class="co">#   ), size = 2, alpha = 1) +</span></span>
<span><span class="co">#   geom_point(aes(</span></span>
<span><span class="co">#     x = coords[, 1], y = coords[, 2],</span></span>
<span><span class="co">#     colour = Y_mean</span></span>
<span><span class="co">#   ), size = 2, alpha = 1) +</span></span>
<span><span class="co">#   scale_color_gradientn(colours = viridis(100)) +</span></span>
<span><span class="co">#   geom_path(aes(x = PRborder[, 1], y = PRborder[, 2])) +</span></span>
<span><span class="co">#   geom_path(aes(x = PRborder[1034:1078, 1], y = PRborder[</span></span>
<span><span class="co">#     1034:1078,</span></span>
<span><span class="co">#     2</span></span>
<span><span class="co">#   ]), colour = "red")</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cross-validation">Cross-validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h3>
<p>We can further validate our model by using cross-validation
method.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cross_validation(out, type="k-fold", k=10, print=TRUE)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David Bolin, Xiaotian Jin, Alexandre Simas, Jonas Wallin.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
