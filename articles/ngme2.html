<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ngme2">
<title>Ngme2 - A new Flexible R Package for Latent non-Gaussian Models • ngme2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Ngme2 - A new Flexible R Package for Latent non-Gaussian Models">
<meta property="og:description" content="ngme2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ngme2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/ngme2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/config_OSX.html">Ngme2 Configuration in OS X</a>
    <a class="dropdown-item" href="../articles/ngme_models.html">Ngme2 Models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Ngme2 - A new Flexible R Package for Latent non-Gaussian Models</h1>
            
            <h4 data-toc-skip class="date">2022-11-14</h4>
      
      
      <div class="d-none name"><code>ngme2.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we provide a brief introduction to the
<code>ngme2</code> package.</p>
<p><code>ngme2</code> is the updated version of <code>ngme</code> (<a href="https://github.com/davidbolin/ngme" class="external-link uri">https://github.com/davidbolin/ngme</a>), a package for
estimating latent non-Gaussian models. It follows a <strong>3-layer
structure</strong> in design (the general block model, latent process
models, and noises) for specifying the whole statistical model. The
latent process defines different operator structure, and the block model
collects them together with the fixed effects and measurement noise.</p>
<div class="section level3">
<h3 id="features">1 Features<a class="anchor" aria-label="anchor" href="#features"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Support spatial models like Matern model with non-Gaussian
noise.</li>
<li>Support models for temporal data like <strong>AR1</strong> and
<strong>random walk</strong> of order 1 and 2.</li>
<li>Support replicates at same locations.</li>
<li>Support prediction at unknown locations.</li>
<li>Comparing to the previous version, it now supports multiple
stochastic processes in the latent model.</li>
</ol>
</div>
<div class="section level3">
<h3 id="model-framework">2 Model Framework<a class="anchor" aria-label="anchor" href="#model-framework"></a>
</h3>
<p>The package <code>ngme2</code> provides methods for mixed effect
models both for single response variable case and multivariate response
case (not yet).</p>
<p>1.For <strong>single response</strong> case, it has the following
form: <span class="math display">\[
\begin{aligned}
Y = {\bf X}^{\top} {\bf \beta} + \sum_j {\bf A}_j W_j({\bf t}) +
\epsilon.
\end{aligned}
\]</span></p>
<p>Here,</p>
<ul>
<li>
<span class="math inline">\(Y\)</span> is the response
variable,</li>
<li>
<span class="math inline">\({\bf X}\)</span> is the matrix of fixed
effects explanatory variables,</li>
<li>
<span class="math inline">\({\bf \beta}\)</span> is the matrix of
fixed effects coefficients,</li>
<li>
<span class="math inline">\({\bf A}_j\)</span> is the observation
matrix for each process,</li>
<li>
<span class="math inline">\(W_j(t_j)\)</span> is specified as a
stochastic process,</li>
<li>
<span class="math inline">\(\epsilon\)</span> is measurement
error.</li>
</ul>
<p>Here, the process <span class="math inline">\(W\)</span> follows
<span class="math inline">\({\bf K} W = z\)</span>, where <span class="math inline">\(z\)</span> is either Gaussian or non-Gaussian
noise. <span class="math inline">\({\bf K}\)</span> is the operator
matrix.</p>
<p>Here is a simple template for using the core function
<code>ngme</code> to model the single response:</p>
<pre><code><span><span class="fu"><a href="../reference/ngme.html">ngme</a></span><span class="op">(</span></span>
<span>  formula<span class="op">=</span><span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span><span class="va">index</span>, model<span class="op">=</span><span class="st">"ar"</span>, noise<span class="op">=</span><span class="st">"nig"</span><span class="op">)</span>,</span>
<span>  data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, x1<span class="op">=</span><span class="va">x1</span>, x2<span class="op">=</span><span class="va">x2</span>, index<span class="op">=</span><span class="va">index</span><span class="op">)</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu">noise_normal</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p>Here, function <code>f</code> is for modeling the stochastic process
W with Gaussian or non-Gaussian noise, we will discuss this later.
<code>noise</code> stands for the measurement noise distribution. In
this case, the model will have a Gaussian likelihood.</p>
<p>For <strong>multivariate response</strong> case, it has the following
form:</p>
<p>Here is a another template for using the core function
<code>ngme</code> to model the bivariate response:</p>
<pre><code><span><span class="fu"><a href="../reference/ngme.html">ngme</a></span><span class="op">(</span></span>
<span>  formula<span class="op">=</span><span class="va">Y1</span> <span class="op">|</span> <span class="va">Y2</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span><span class="va">index</span>, model<span class="op">=</span><span class="st">"ar"</span>, noise<span class="op">=</span><span class="st">"nig"</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span><span class="va">time</span>, model<span class="op">=</span><span class="st">"matern"</span><span class="op">)</span>,</span>
<span>  data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, x1<span class="op">=</span><span class="va">x1</span>, x2<span class="op">=</span><span class="va">x2</span>, index<span class="op">=</span><span class="va">index</span>, time<span class="op">=</span><span class="va">time</span><span class="op">)</span>,</span>
<span>  family<span class="op">=</span><span class="st">"normal"</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="non-gaussian-model">3 Non-Gaussian Model<a class="anchor" aria-label="anchor" href="#non-gaussian-model"></a>
</h3>
<p>Here we assume the non-Gaussian process is a type-G Lévy process,
whose increments can be represented as location-scale mixtures: <span class="math display">\[\gamma + \mu V + \sigma \sqrt{V}Z,\]</span> where
<span class="math inline">\(\gamma, \mu, \sigma\)</span> are parameters,
<span class="math inline">\(Z\sim N(0,1)\)</span> and is independent of
<span class="math inline">\(V\)</span>, and <span class="math inline">\(V\)</span> is a positive infinitely divisible
random variable. It results in the following form, where <span class="math inline">\(K\)</span> is the operator part:</p>
<p><span class="math display">\[
KW|V \sim N(\gamma + \mu V, \sigma^2 \, diag(V)),
\]</span> also, <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> can be non-stationary.</p>
<p>In Ngme2, we focus mainly on the normal inverse Gaussian (NIG)
model.</p>
<div class="section level4">
<h4 id="the-nig-model">The NIG model<a class="anchor" aria-label="anchor" href="#the-nig-model"></a>
</h4>
<p>First, we say that a random variable <span class="math inline">\(V\)</span> follows an inverse Gaussian
distribution with parameters <span class="math inline">\(\eta_1\)</span>
and <span class="math inline">\(\eta_2\)</span>, denoted by <span class="math inline">\(V\sim IG(\eta_1,\eta_2)\)</span> if it has pdf
given by</p>
<p><span class="math display">\[\pi(v) = \frac{\sqrt{\eta_2}}{\sqrt{2\pi
v^3}} \exp\left\{-\frac{\eta_1}{2}v - \frac{\eta_2}{2v} +
\sqrt{\eta_1\eta_2}\right\},\quad \eta_1,\eta_2&gt;0.\]</span></p>
<p>We can generate samples of inverse Gaussian distributions with
parameters <span class="math inline">\(\eta_1\)</span> and <span class="math inline">\(\eta_2\)</span> by generating samples from the <a href="https://en.wikipedia.org/wiki/Generalized_inverse_Gaussian_distribution" class="external-link">generalized
inverse Gaussian distribution</a> with parameters <span class="math inline">\(p=-1/2\)</span>, <span class="math inline">\(a=\eta_1\)</span> and <span class="math inline">\(b=\eta_2\)</span>. We can use the <em>rGIG</em>
function to generate samples from the generalized inverse Gaussian
distribution.</p>
<p>If <span class="math inline">\(V\sim IG(\eta_1,\eta_2)\)</span>, then
<span class="math inline">\(X = \gamma +\mu V + \sigma
\sqrt{V}Z\)</span>, with <span class="math inline">\(Z\sim
N(0,1)\)</span>, being independent of <span class="math inline">\(V\)</span>, then <span class="math inline">\(X\)</span> follows a normal inverse Gaussian (NIG)
distribution and has pdf <span class="math display">\[\pi(x) =
\frac{e^{\sqrt{\eta_1\eta_2}+\mu(x-\gamma)/\sigma^2}\sqrt{\eta_2\mu^2/\sigma^2+\eta_1\eta_2}}{\pi\sqrt{\eta_2\sigma^2+(x-\gamma)^2}}
K_1\left(\sqrt{(\eta_2\sigma^2+(x-\gamma)^2)(\mu^2/\sigma^4+\eta_1/\sigma^2)}\right),\]</span>
where <span class="math inline">\(K_1\)</span> is a modified Bessel
function of the third kind. In this form, the NIG density is
overparameterized, and we therefore set <span class="math inline">\(\eta_1=\eta_2=\eta\)</span>, which results in
<span class="math inline">\(E(V)=1\)</span>. Thus, one have the
parameters, <span class="math inline">\(\mu, \gamma\)</span> and <span class="math inline">\(\eta\)</span>.</p>
<p>The NIG model thus assumes that the stochastic variance <span class="math inline">\(V_i\)</span> follows an inverse Gaussian with
parameters <span class="math inline">\(\eta\)</span> and <span class="math inline">\(\eta h_i^2\)</span>, where <span class="math inline">\(h_i = \int_{\mathcal{D}} \varphi_i(\mathbf{s})
d\mathbf{s}.\)</span></p>
<p>Below, we see the plot of the densities of a NIG distribution for
several choices of the parameters (we fix <span class="math inline">\(\gamma=0\)</span> and <span class="math inline">\(\eta=1\)</span>):</p>
</div>
</div>
<div class="section level3">
<h3 id="parameter-estimation">4 Parameter Estimation<a class="anchor" aria-label="anchor" href="#parameter-estimation"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Ngme2 does maximum likelihood estimation through preconditioned
stochastic gradient descent.</li>
<li>Multiple chains are run in parallel for better convergence
checks.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="ngme-model-structure---3-layer-structure">Ngme Model Structure - 3-Layer structure<a class="anchor" aria-label="anchor" href="#ngme-model-structure---3-layer-structure"></a>
</h2>
<div class="section level3">
<h3 id="specify-noise-with-ngme_noise-object">Specify noise with <code>ngme_noise</code> object<a class="anchor" aria-label="anchor" href="#specify-noise-with-ngme_noise-object"></a>
</h3>
<p>The <code>ngme_noise</code> object is the most fundamental structure
in <code>ngme2</code>. The object is used to specify the driving noise
of the stochastic process and the measurement noise.</p>
<p>For now we support two noises, one is <strong>normal</strong> noise,
the other is the <strong>NIG</strong> noise.</p>
<p>The R class <code>ngme_noise</code> has the following interface:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidbolin.github.io/ngme2/">ngme2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">noise_normal</span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>                 <span class="co"># normal noise</span></span>
<span><span class="co">#&gt; Noise type - normal</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     sigma = 1</span></span>
<span><span class="fu">noise_nig</span><span class="op">(</span>mu <span class="op">=</span> <span class="fl">1</span>, sigma <span class="op">=</span> <span class="fl">2</span>, nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># nig noise</span></span>
<span><span class="co">#&gt; Noise type - nig</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     mu = 1</span></span>
<span><span class="co">#&gt;     sigma = 2</span></span>
<span><span class="co">#&gt;     nu = 1</span></span>
<span><span class="fu">noise_nig</span><span class="op">(</span>            <span class="co"># non-stationary nig noise</span></span>
<span>  B_mu<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  theta_mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  B_sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  theta_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>  nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Noise type - nig</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     theta_mu = 1, 2</span></span>
<span><span class="co">#&gt;     theta_sigma = 1, 2</span></span>
<span><span class="co">#&gt;     nu = 1</span></span></code></pre></div>
<p>The 3rd example is the non-stationary NIG noise, where <span class="math inline">\(\mu = \bf B_{\mu} \bf \theta_{\mu}\)</span>, and
<span class="math inline">\(\sigma = \exp(\bf B_{\sigma} \bf
\theta_{\sigma})\)</span>.</p>
<pre><code><span><span class="fu">ngme_noise</span><span class="op">(</span></span>
<span>  <span class="va">type</span>,           <span class="co"># the type of noise</span></span>
<span>  <span class="va">theta_mu</span>,       <span class="co"># mu parameter</span></span>
<span>  <span class="va">theta_sigma</span>,    <span class="co"># sigma parameter</span></span>
<span>  <span class="va">theta_V</span>,        <span class="co"># nu parameter</span></span>
<span>  <span class="va">B_mu</span>,           <span class="co"># basis matrix for non-stationary mu</span></span>
<span>  <span class="va">B_sigma</span>         <span class="co"># basis matrix for non-stationary sigma</span></span>
<span><span class="op">)</span></span></code></pre>
<p>It will construct the following noise structure:</p>
<p><span class="math display">\[
  - \mathbf{\mu} + \mathbf{\mu} V + \mathbf{\sigma} \sqrt{V} Z
\]</span></p>
<p>where <span class="math inline">\(\mu = \bf B_{\mu} \bf
\theta_{\mu}\)</span>, and <span class="math inline">\(\sigma = \exp(\bf
B_{\sigma} \bf \theta_{\sigma})\)</span>. In this case, we can recover
gaussian noise by setting <strong>type=“normal</strong> and ignoring
<strong>theta_mu</strong> and <strong>theta_V</strong>. Or we can simply
use helper function <code>noise_normal(sd=1)</code></p>
</div>
<div class="section level3">
<h3 id="specify-stochastic-process-with-f-function">Specify stochastic process with <code>f</code> function<a class="anchor" aria-label="anchor" href="#specify-stochastic-process-with-f-function"></a>
</h3>
<p>The middle layer is the stochastic process, in R interface, it is
represented as a <code>f</code> function. The process can be specified
by different noise structure.</p>
<p>Some examples of using <code>f</code> function to specify
<code>ngme_model</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, model <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>  noise <span class="op">=</span> <span class="fu">noise_nig</span><span class="op">(</span><span class="op">)</span>, theta_K <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; as(&lt;dgTMatrix&gt;, "dgCMatrix") is deprecated since Matrix 1.5-0; do as(., "CsparseMatrix") instead</span></span>
<span><span class="co">#&gt; Ngme model: ar1</span></span>
<span><span class="co">#&gt; Model parameters: </span></span>
<span><span class="co">#&gt;     alpha = 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Noise type - nig</span></span>
<span><span class="co">#&gt; Noise parameters: </span></span>
<span><span class="co">#&gt;     mu = 0</span></span>
<span><span class="co">#&gt;     sigma = 1</span></span>
<span><span class="co">#&gt;     nu = 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="specify-latent-model-with-formula-in-ngme">Specify latent model with formula in <code>ngme</code><a class="anchor" aria-label="anchor" href="#specify-latent-model-with-formula-in-ngme"></a>
</h3>
<p>The latent model can be specified additively as a
<strong>formula</strong> argument in <code>ngme</code> function together
with <strong>fixed effects</strong>.</p>
<p>It can be specified as following:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ngme.html">ngme</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span></span>
<span>    index <span class="op">=</span> <span class="va">x2</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>    noise <span class="op">=</span> <span class="fu">noise_nig</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    theta_K <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="fu">model_rw</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, order<span class="op">=</span><span class="fl">1</span>, circular <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    noise <span class="op">=</span> <span class="fu">noise_normal</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">noise_normal</span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, x1 <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">6</span>, x2 <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">ngme_control</span><span class="op">(</span></span>
<span>    estimation <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; *** Ngme object ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects: </span></span>
<span><span class="co">#&gt;    beta = -1,  1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement noise: </span></span>
<span><span class="co">#&gt;   Noise type - normal</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       sigma = 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent models: </span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   Ngme model: ar1</span></span>
<span><span class="co">#&gt;   Model parameters: </span></span>
<span><span class="co">#&gt;       alpha = 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Noise type - nig</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       mu = 0</span></span>
<span><span class="co">#&gt;       sigma = 1</span></span>
<span><span class="co">#&gt;       nu = 1</span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;   Ngme model: rw1</span></span>
<span><span class="co">#&gt;   Model parameters: </span></span>
<span><span class="co">#&gt;       No parameter needed.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Noise type - normal</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       sigma = 1</span></span></code></pre></div>
<p>It gives the <code>ngme</code> object, which has three parts:</p>
<ol style="list-style-type: decimal">
<li>Fixed effects (intercept and x1)</li>
<li>Measurement noise (normal noise)</li>
<li>Latent models (contains 2 models, ar1 and rw1)</li>
</ol>
<p>We can turn the <code>estimation = TRUE</code> to start estimating
the model.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-spde-approach-with-gaussian-noise">The SPDE approach with Gaussian noise<a class="anchor" aria-label="anchor" href="#the-spde-approach-with-gaussian-noise"></a>
</h2>
<p>It is well-known (Whittle, 1963) that a Gaussian process <span class="math inline">\(u(\mathbf{s})\)</span> with Matérn covariance
function solves the stochastic partial differential equation (SPDE)
<span class="math display">\[\begin{equation}\label{spde}
(\kappa^2 -\Delta)^\beta u = \mathcal{W}\quad \hbox{in } \mathcal{D},
\end{equation}\]</span> where <span class="math inline">\(\Delta =
\sum_{i=1}^d \frac{\partial^2}{\partial_{x_i^2}}\)</span> is the
Laplacian operator, <span class="math inline">\(\mathcal{W}\)</span> is
the Gaussian spatial white noise on <span class="math inline">\(\mathcal{D}=\mathbb{R}^d\)</span>, and <span class="math inline">\(4\beta = 2\nu + d\)</span>.</p>
<p>Inspired by this relation between Gaussian processes with Matérn
covariance functions and solutions of the above SPDE, <a href="https://rss.onlinelibrary.wiley.com/doi/full/10.1111/j.1467-9868.2011.00777.x" class="external-link">Lindgren
et al. (2011)</a> constructed computationally efficient Gaussian Markov
random field approximations of <span class="math inline">\(u(\mathbf{s})\)</span>, where the domain <span class="math inline">\(\mathcal{D}\subsetneq \mathbb{R}^d\)</span> is
bounded and <span class="math inline">\(2\beta\in\mathbb{N}\)</span>.</p>
<p>The motivation for handling non-Gaussian noise comes from the fact
that many features cannot not be handled by Gaussian noise. Some of
these reasons are:</p>
<ul>
<li>Skewness;</li>
<li>Heavier tails;</li>
<li>Jumps in the sample paths;</li>
<li>Asymmetries in the sample paths.</li>
</ul>
<div class="section level3">
<h3 id="non-gaussian-matérn-fields">Non-Gaussian Matérn fields<a class="anchor" aria-label="anchor" href="#non-gaussian-mat%C3%A9rn-fields"></a>
</h3>
<p>The idea is to replace the Gaussian white noise <span class="math inline">\(\mathcal{W}\)</span> in the SPDE by a non-Gaussian
white noise <span class="math inline">\(\dot{\mathcal{M}}\)</span>:
<span class="math display">\[(\kappa^2 - \Delta)^\beta u =
\dot{\mathcal{M}}.\]</span> The solution <span class="math inline">\(u\)</span> will have Matérn covariance function,
but their marginal distributions will be non-Gaussian.</p>
<p>We want to apply the same idea to the non-Gaussian case, i.e., we
want to consider the SPDE on a bounded domain <span class="math inline">\(\mathcal{D}\subset\mathbb{R}^d\)</span> and apply
the finite element method.</p>
<p>Notice that the left-hand side of the equation did not change.
Therefore, we should only take care of the right-hand side.</p>
<p>We will consider the same setup. More precisely, we consider <span class="math inline">\(V_n = {\rm
span}\{\varphi_1,\ldots,\varphi_n\}\)</span>, where <span class="math inline">\(\varphi_i(\mathbf{s}), i=1,\ldots, n\)</span> are
piecewise linear basis functions obtained from a triangulation of <span class="math inline">\(\mathcal{D}\)</span> and we approximate the
solution <span class="math inline">\(u\)</span> by <span class="math inline">\(u_n\)</span>, where <span class="math inline">\(u_n\)</span> is written in terms of the basis
functions as <span class="math display">\[u_n(\mathbf{s}) = \sum_{i=1}^n
w_i \varphi_i(\mathbf{s}).\]</span> In the right-hand side we obtain a
random vector <span class="math display">\[\mathbf{f} =
(\dot{\mathcal{M}}(\varphi_1),\ldots,
\dot{\mathcal{M}}(\varphi_n)),\]</span> where the functional <span class="math inline">\(\dot{\mathcal{M}}\)</span> is given by <span class="math display">\[\dot{\mathcal{M}}(\varphi_j) = \int_{\mathcal{D}}
\varphi_j(\mathbf{s}) d\mathcal{M}(\mathbf{s}).\]</span> By considering
<span class="math inline">\(\mathcal{M}\)</span> to be a type-G Lévy
process, we obtain that <span class="math inline">\(\mathbf{f}\)</span>
has a joint distribution that is easy to handle.</p>
<p>We say that a Lévy process is of type G if its increments can be
represented as location-scale mixtures: <span class="math display">\[\gamma + \mu V + \sigma \sqrt{V}Z,\]</span> where
<span class="math inline">\(\gamma, \mu\)</span> are parameters, <span class="math inline">\(Z\sim N(0,1)\)</span> and is independent of <span class="math inline">\(V\)</span>, and <span class="math inline">\(V\)</span> is a positive infinitely divisible
random variable.</p>
<p>Therefore, given a vector <span class="math inline">\(\mathbf{V} =
(V_1,\ldots,V_n)\)</span> of independent stochastic variances (in our
case, positive infinitely divisible random variables), we obtain that
<span class="math display">\[\mathbf{f}|\mathbf{V} \sim N(\gamma +
\mu\mathbf{V}, \sigma^2{\rm diag}(\mathbf{V})).\]</span> So, if we
consider, for instance, the non-fractional and non-Gaussian SPDE <span class="math display">\[(\kappa^2 - \Delta) u =
\dot{\mathcal{M}},\]</span> we obtain that the FEM weights <span class="math inline">\(\mathbf{w} = (w_1,\ldots,w_n)\)</span> satisfy
<span class="math display">\[\mathbf{w}|\mathbf{V} \sim
N(\mathbf{K}^{-1}(\gamma+\mu\mathbf{V}), \sigma^2\mathbf{K}^{-1}{\rm
diag}(\mathbf{V})\mathbf{K}^{-1}),\]</span> where <span class="math inline">\(\mathbf{K} =
\kappa^2\mathbf{C}+\mathbf{G}\)</span> is the discretization of the
differential operator.</p>
</div>
<div class="section level3">
<h3 id="computational-advantages-of-the-spde-approach">Computational advantages of the SPDE approach<a class="anchor" aria-label="anchor" href="#computational-advantages-of-the-spde-approach"></a>
</h3>
<p>For spatial problems, the computational cost usually scales as <span class="math inline">\(\mathcal{O}(n^{3/2})\)</span>, where <span class="math inline">\(n\)</span> is the number of basis functions. This
should be compared to the <span class="math inline">\(\mathcal{O}(N^3)\)</span> of the Gaussian random
field approach.</p>
<p>This implies in accurate approximations which drastically reduces the
computational cost for sampling and inference.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-simple-example---ar1-process-with-nig-noise">A simple example - AR1 process with nig noise<a class="anchor" aria-label="anchor" href="#a-simple-example---ar1-process-with-nig-noise"></a>
</h2>
<p>Now let’s see an example of an AR1 process with nig noise. The
process is defined as</p>
<p><span class="math display">\[
W_i = \alpha W_{i-1} + \epsilon_i,
\]</span> Here, <span class="math inline">\(\epsilon_1,
..,\epsilon_n\)</span> is the iid <strong>NIG</strong> noise. And, it is
easy to verify that <span class="math display">\[ K{\bf W} =
\boldsymbol\epsilon,\]</span> where <span class="math display">\[
K =
  \begin{bmatrix}
    \alpha \\
    -1 &amp;  \alpha \\
    &amp; \ddots &amp; \ddots \\
    &amp; &amp; -1 &amp;  \alpha
  \end{bmatrix}
\]</span></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">sigma_eps</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">mu</span> <span class="op">=</span> <span class="fl">2</span>; <span class="va">delta</span> <span class="op">=</span> <span class="op">-</span><span class="va">mu</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">nu</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># First we generate V. V_i follows inverse Gaussian distribution</span></span>
<span><span class="va">trueV</span> <span class="op">&lt;-</span> <span class="fu">ngme2</span><span class="fu">::</span><span class="fu"><a href="../reference/ig.html">rig</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="va">nu</span>, <span class="va">nu</span>, seed <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then generate the nig noise</span></span>
<span><span class="va">noise</span> <span class="op">&lt;-</span> <span class="va">delta</span> <span class="op">+</span> <span class="va">mu</span><span class="op">*</span><span class="va">trueV</span> <span class="op">+</span> <span class="va">sigma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">trueV</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span></span>
<span><span class="va">trueW</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">{</span><span class="va">y</span> <span class="op">+</span> <span class="va">alpha</span><span class="op">*</span><span class="va">x</span><span class="op">}</span>, <span class="va">noise</span>, accumulate <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">trueW</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="va">sigma_eps</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add some fixed effects</span></span>
<span><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span><span class="op">)</span>  <span class="co"># design matrix</span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">+</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s fit the model using <code>ngme</code>. Here we can use
<code>ngme_control</code> to modify the control variables for the
<code>ngme</code>. See <code>?ngme_control</code> for more optioins.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># # Fit the model with the AR1 model</span></span>
<span><span class="va">ngme_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ngme.html">ngme</a></span><span class="op">(</span></span>
<span>  <span class="va">Y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">n_obs</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"ar1"</span>,</span>
<span>    noise <span class="op">=</span> <span class="fu">noise_nig</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    theta_K <span class="op">=</span> <span class="fl">0.9</span>  <span class="co"># starting point for the alpha (parameter of K)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1<span class="op">=</span><span class="va">x1</span>, x2<span class="op">=</span><span class="va">x2</span>, Y<span class="op">=</span><span class="va">Y</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">ngme_control</span><span class="op">(</span></span>
<span>    burnin <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    std_lim <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>    gibbs_sample <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    n_parallel_chain <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    stop_points <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    print_check_info <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting estimation... </span></span>
<span><span class="co">#&gt; Estimation done!</span></span></code></pre></div>
<p>Next we can read the result directly from the object.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ngme_out</span></span>
<span><span class="co">#&gt; *** Ngme object ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects: </span></span>
<span><span class="co">#&gt;    beta = -2.91, -1.44,  1.99</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement noise: </span></span>
<span><span class="co">#&gt;   Noise type - normal</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       sigma = 0.788</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent models: </span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   Ngme model: ar1</span></span>
<span><span class="co">#&gt;   Model parameters: </span></span>
<span><span class="co">#&gt;       alpha = 0.564</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Noise type - nig</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       mu = 1.86</span></span>
<span><span class="co">#&gt;       sigma = 2.82</span></span>
<span><span class="co">#&gt;       nu = 0.831</span></span></code></pre></div>
<p>As we can see, the model converges in 350 iterations. The estimation
results are close to the real parameter.</p>
<p>We can also use the <code>traceplot</code> function to see the
estimation traceplot.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"mu"</span>, <span class="st">"sigma"</span>, <span class="st">"nu"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="fu">traceplot</span><span class="op">(</span><span class="va">ngme_out</span>, parameter <span class="op">=</span> <span class="va">.x</span>, f_index <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">marrangeGrob</a></span><span class="op">(</span><span class="va">pl</span>, nrow<span class="op">=</span><span class="fl">2</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ngme2_files/figure-html/traceplot-1.png" alt="Parameters of the AR1 model" width="576"><p class="caption">
Parameters of the AR1 model
</p>
</div>
<p>We can also do a density comparison with the estimated noise and the
true NIG noise:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">ngme_out</span><span class="op">$</span><span class="va">latents</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">noise</span>,</span>
<span>  <span class="fu">noise_nig</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">mu</span>, sigma <span class="op">=</span> <span class="va">sigma</span>, nu <span class="op">=</span> <span class="va">nu</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="ngme2_files/figure-html/compare-density-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="parana-dataset">Parana dataset<a class="anchor" aria-label="anchor" href="#parana-dataset"></a>
</h2>
<p>The rainfall data from Paraná (Brazil) is collected by the National
Water Agency in Brazil (Agencia Nacional de Águas, ANA, in Portuguese).
ANA collects data from many locations over Brazil, and all these data
are freely available from the ANA website (<a href="http://www3.ana.gov.br/portal/ANA" class="external-link uri">http://www3.ana.gov.br/portal/ANA</a>).</p>
<p>We will briefly illustrate the command we use, and the result of the
estimation.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; Loading required package: foreach</span></span>
<span><span class="co">#&gt; Loading required package: parallel</span></span>
<span><span class="co">#&gt; Loading required package: sp</span></span>
<span><span class="co">#&gt; This is INLA_22.11.08 built 2022-11-08 17:53:54 UTC.</span></span>
<span><span class="co">#&gt;  - See www.r-inla.org/contact-us for how to get help.</span></span>
<span><span class="co">#&gt;  - To enable PARDISO sparse library; see inla.pardiso()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'INLA'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:ngme2':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     f</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.maths.lancs.ac.uk/~rowlings/Splancs/" class="external-link">splancs</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Spatial Point Pattern Analysis Code in S-Plus</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt;  Version 2 - Spatial and Space-Time analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">PRborder</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create INLA mesh</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">prdomain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.nonconvex.hull.html" class="external-link">inla.nonconvex.hull</a></span><span class="op">(</span><span class="va">coords</span>, <span class="op">-</span><span class="fl">0.03</span>, <span class="op">-</span><span class="fl">0.05</span>, resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prmesh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.mesh.2d.html" class="external-link">inla.mesh.2d</a></span><span class="op">(</span>boundary <span class="op">=</span> <span class="va">prdomain</span>, max.edge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">1</span><span class="op">)</span>, cutoff <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># monthly mean at each location</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span>, <span class="fl">12</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">31</span><span class="op">]</span><span class="op">)</span> <span class="co"># 2 + Octobor</span></span>
<span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="co"># non-NA index</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y_mean</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span><span class="va">ind</span><span class="op">]</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">PRprec</span><span class="op">[</span><span class="va">ind</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">seaDist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spDistsN1.html" class="external-link">spDists</a></span><span class="op">(</span><span class="va">coords</span>, <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="op">]</span>,</span>
<span>  longlat <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">min</span><span class="op">)</span></span></code></pre></div>
<p>Plot the data:</p>
<div class="figure" style="text-align: center">
<img src="ngme2_files/figure-html/unnamed-chunk-6-1.png" alt="Mean of the rainfall in Octobor 2012 in Paraná" width="576"><p class="caption">
Mean of the rainfall in Octobor 2012 in Paraná
</p>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># leave 0.1 Y as prediction area</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">ind_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, size <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y_pred</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span><span class="va">ind_pred</span><span class="op">]</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">ind_pred</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">A</span>       <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, loc <span class="op">=</span> <span class="va">coords</span><span class="op">[</span><span class="op">-</span><span class="va">ind_pred</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">A_pred</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.A.html" class="external-link">inla.spde.make.A</a></span><span class="op">(</span>mesh <span class="op">=</span> <span class="va">prmesh</span>, loc <span class="op">=</span> <span class="va">coords</span><span class="op">[</span><span class="va">ind_pred</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mesh.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.spde.make.index.html" class="external-link">inla.spde.make.index</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"field"</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">prmesh</span>,</span>
<span>  n.spde <span class="op">=</span> <span class="va">prmesh</span><span class="op">$</span><span class="va">n</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">matern_spde</span> <span class="op">&lt;-</span> <span class="fu">model_matern</span><span class="op">(</span></span>
<span>  loc <span class="op">=</span> <span class="va">coords</span>,</span>
<span>  mesh <span class="op">=</span> <span class="va">prmesh</span>,</span>
<span>  index_NA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ngme.html">ngme</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span></span>
<span>    <span class="co"># f(inla.group(seaDist), model = "rw1", noise=noise_normal()) +</span></span>
<span>    <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">matern_spde</span>, noise <span class="op">=</span> <span class="fu">noise_nig</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/f.html">f</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">matern_spde</span>, noise <span class="op">=</span> <span class="fu">noise_normal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span></span>
<span>  <span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu">noise_nig</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">ngme_control</span><span class="op">(</span></span>
<span>    estimation <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    iterations <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    n_slope_check <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    stop_points <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    std_lim <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    n_parallel_chain <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    print_check_info <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">416</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Starting estimation... </span></span>
<span><span class="co">#&gt; Estimation done!</span></span>
<span></span>
<span><span class="va">out</span></span>
<span><span class="co">#&gt; *** Ngme object ***</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects: </span></span>
<span><span class="co">#&gt;    beta = 9.56</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Measurement noise: </span></span>
<span><span class="co">#&gt;   Noise type - nig</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       mu = 0.496</span></span>
<span><span class="co">#&gt;       sigma = 2.27</span></span>
<span><span class="co">#&gt;       nu = 1.54</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Latent models: </span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   Ngme model: matern</span></span>
<span><span class="co">#&gt;   Model parameters: </span></span>
<span><span class="co">#&gt;       kappa = 0.948</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Noise type - nig</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       mu = 0.31</span></span>
<span><span class="co">#&gt;       sigma = 2.45</span></span>
<span><span class="co">#&gt;       nu = 0.727</span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;   Ngme model: matern</span></span>
<span><span class="co">#&gt;   Model parameters: </span></span>
<span><span class="co">#&gt;       kappa = 0.965</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Noise type - normal</span></span>
<span><span class="co">#&gt;   Noise parameters: </span></span>
<span><span class="co">#&gt;       sigma = 1.75</span></span>
<span><span class="co"># Comparing our prediction</span></span>
<span><span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">out</span>, <span class="st">"prediction"</span><span class="op">)</span><span class="op">$</span><span class="va">lp</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">lp</span> <span class="op">-</span> <span class="va">Y_mean</span><span class="op">)</span><span class="op">)</span>  <span class="co">#MAE</span></span>
<span><span class="co">#&gt; [1] 1.69781</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>  colour <span class="op">=</span>  <span class="va">Y_mean</span> <span class="op">-</span> <span class="va">lp</span></span>
<span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">tim.colors</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span><span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>, <span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">PRborder</span><span class="op">[</span></span>
<span>  <span class="fl">1034</span><span class="op">:</span><span class="fl">1078</span>,</span>
<span>  <span class="fl">2</span></span>
<span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngme2_files/figure-html/plot-prediction-1.png" width="700"></p>
<p>Model estimation:</p>
<table style="width:100%;" class="table">
<caption>Estimations for the model</caption>
<colgroup>
<col width="12%">
<col width="11%">
<col width="15%">
<col width="11%">
<col width="11%">
<col width="11%">
<col width="7%">
<col width="11%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="left">intercept</th>
<th align="left">noise_mu</th>
<th align="left">noise_sigma</th>
<th align="left">noise_nu</th>
<th align="left">rw_sigma</th>
<th align="left">ma_kappa</th>
<th align="left">ma_mu</th>
<th align="left">ma_sigma</th>
<th align="left">ma_nu</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">9.56</td>
<td align="left">0.496</td>
<td align="left">2.27</td>
<td align="left">1.54</td>
<td align="left">0.896</td>
<td align="left">0.965</td>
<td align="left">0</td>
<td align="left">1.75</td>
<td align="left">1</td>
</tr></tbody>
</table>
<p>Result of the optimization trajectory of parameters for the Matern
model:</p>
<div class="figure" style="text-align: center">
<img src="ngme2_files/figure-html/unnamed-chunk-8-1.png" alt="Traceplot of Matern parameters" width="768"><p class="caption">
Traceplot of Matern parameters
</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Bolin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
