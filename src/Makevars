# Set UNAME to detect the operating system
UNAME := $(shell uname)

# Make the shared object
$(SHLIB): $(OBJECTS) $(sslib)

# Compile Suitesparse
ssdir = SuiteSparse
sslib = $(sslib1) $(sslib2) $(sslib3) $(sslib4) $(sslib5) $(sslib6) $(sslib7)
sslib1 = $(ssdir)/CHOLMOD/CHOLMOD.a
sslib2 = $(ssdir)/CCOLAMD/CCOLAMD.a
sslib3 = $(ssdir)/CAMD/CAMD.a
sslib4 = $(ssdir)/COLAMD/COLAMD.a
sslib5 = $(ssdir)/AMD/AMD.a
sslib6 = $(ssdir)/CXSparse/CXSparse.a
sslib7 = $(ssdir)/SuiteSparse_config/SuiteSparse_config.a

ssenv = \
	CC="$(CC)" \
	CPPFLAGS="$(CPPFLAGS) -I\"$(R_INCLUDE_DIR)\" -DNDEBUG -DNPRINT -DNTIMER" \
	CFLAGS="$(CFLAGS) $(CPICFLAGS) $(C_VISIBILITY)" \
	AR="$(AR)" \
	RANLIB="$(RANLIB)"


PKG_CPPFLAGS = -I"$(ssdir)/SuiteSparse_config"
PKG_CFLAGS = $(C_VISIBILITY)
PKG_LIBS = $(sslib) $(LAPACK_LIBS) $(BLAS_LIBS) $(FLIBS)
# PKG_LIBS += $(sslib1)

PKG_CPPFLAGS += -Iinclude -I../inst/include # -DNDEBUG -DDEBUG
PKG_CXXFLAGS += $(SHLIB_OPENMP_CXXFLAGS)

## NB: INSTALL does not clean subdirectories between subarchitectures
$(sslib1), $(sslib2), $(sslib3), $(sslib4), $(sslib5), $(sslib6), $(sslib7) :
	cd $(@D) && $(MAKE) clean all $(ssenv)


# macOS uses Accelerate, Linux uses system BLAS/LAPACK or MKL
ifeq ($(UNAME), Darwin)
  PKG_LIBS += -framework Accelerate
endif

R_XTRA_CPPFLAGS =  -I$(R_INCLUDE_DIR)
PKG_LIBS += $(SHLIB_OPENMP_CXXFLAGS)

# PKG_LIBS =  ${LAPACK_LIBS} ${BLAS_LIBS} ${FLIBS}  -L/opt/intel/mkl/lib/intel64 -Wl,--no-as-needed,-rpath,'/opt/intel/mkl/lib/intel64' -lmkl_intel_lp64 -lmkl_gnu_thread -lmkl_core -lgomp -lpthread -lm -ldl

# TESTS = test/test-algebra.o  test/test-opt.o
UTILS = util/num_diff.o util/GIG.o util/rgig.o util/MatrixAlgebra.o util/solver.o
# $(wildcard util/*.o)

LATENTS = latents/ar1.o latents/matern.o latents/tensorprod.o latents/randeff.o latents/bivar.o latents/general.o
# $(wildcard latents/*.o)

OBJECTS = RcppExports.o prior.o noise.o sample_rGIG.o estimate.o optimizer.o block.o latent.o ngme.o \
   $(UTILS) $(TESTS) $(LATENTS)


# Provide recipe to remove all objects
clean:
	@rm -f *.o util/*.o latents/*.o

.PHONY: clean
