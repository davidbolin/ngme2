---
title: "Different models in Parana data"
author: "Xiaotian Jin"
---

Illustruation of fitting parana data using ngme2.

## data

```{r message=FALSE}
# NGME2 test on parana data / similar in ngme2.Rmd
library(INLA)
library(splancs)
library(lattice)
library(ggplot2)
library(grid)
library(gridExtra)
library(viridis)
load_all()

# read data
data(PRprec)
data(PRborder)

############################### Create INLA mesh
coords <- as.matrix(PRprec[, 1:2])
prdomain <- inla.nonconvex.hull(coords, -0.03, -0.05, resolution = c(100, 100))
prmesh <- inla.mesh.2d(boundary = prdomain, max.edge = c(0.45, 1), cutoff = 0.2)

# monthly mean at each location
Y <- rowMeans(PRprec[, 12 + 1:31]) # 2 + Octobor

ind <- !is.na(Y) # non-NA index
Y <- Y_mean <- Y[ind]
coords <- as.matrix(PRprec[ind, 1:2])
seaDist <- apply(spDists(coords, PRborder[1034:1078, ],
  longlat = TRUE
), 1, min)

ggplot() +
  geom_point(aes(
    x = coords[, 1], y = coords[, 2],
    colour = Y
  ), size = 2, alpha = 1) +
  scale_color_gradientn(colours = viridis(100)) +
  geom_path(aes(x = PRborder[, 1], y = PRborder[, 2])) +
  geom_path(aes(x = PRborder[1034:1078, 1], y = PRborder[
    1034:1078,
    2
  ]), colour = "red")

############################### fit the matern model

matern_spde <- model_matern(
  loc = coords,
  mesh = prmesh
)
```

Ok first check with my model_rw
```{r}
rw <- f(inla.group(seaDist), model = "rw1", noise = noise_normal())

f(inla.group(seaDist), model = "rw1", noise = noise_normal())$h
rw$h
str(rw)
```

## case 1. RW1 + SPDE NIG noise + normal measurement noise

```{r case1, cache=TRUE}
nig_m_normal <- ngme(
  formula = Y ~ 1 +
    f(inla.group(seaDist), model = "rw1", noise = noise_normal()) +
    f(model = matern_spde, noise = noise_nig()),
  data = list(
    Y = Y
  ),
  family = noise_normal(),
  control = control_opt(
    estimation = T,
    iterations = 1000,
    n_slope_check = 4,
    stop_points = 10,
    std_lim = 0.1,
    n_parallel_chain = 4,
    print_check_info = FALSE
  ),
  debug = FALSE,
  seed = 16
)

nig_m_normal
traceplot(nig_m_normal, "field2")
plot(nig_m_normal$latents[[1]]$noise, xlim=c(-200, 200))
```

## case 2. RW1 + SPDE NIG noise + NIG measurement noise

```{r case2, cache=TRUE}
nig_m_nig <- ngme(
  formula = Y ~ 1 +
    f(inla.group(seaDist), model = "rw1", noise = noise_normal()) +
    f(model = matern_spde, noise = noise_nig()),
  data = list(
    Y = Y
  ),
  family = noise_nig(),
  control = control_opt(
    estimation = T,
    iterations = 1000,
    n_slope_check = 4,
    stop_points = 10,
    std_lim = 0.1,
    n_parallel_chain = 4,
    print_check_info = FALSE
  ),
  debug = FALSE,
  seed = 16
)

nig_m_nig
```

## case 3. RW1 + SPDE normal_NIG noise + normal measurement noise

```{r case3, cache=TRUE}
normalnig_m_normal <- ngme(
  formula = Y ~ 1 +
    f(inla.group(seaDist), model = "rw1", noise = noise_normal()) +
    f(model = matern_spde, noise = noise_normal_nig()),
  data = list(
    Y = Y
  ),
  family = noise_normal(),
  control = control_opt(
    estimation = T,
    iterations = 1000,
    n_slope_check = 4,
    stop_points = 10,
    std_lim = 0.1,
    n_parallel_chain = 4,
    print_check_info = FALSE
  ),
  debug = FALSE,
  seed = 1000
)

normalnig_m_normal
traceplot(normalnig_m_normal, "field2")
# traceplot2(normalnig_m_normal, "sigma_normal", f_index = 2)
# traceplot2(normalnig_m_normal, "sigma", f_index = 2)
```

## case 4. RW1 + SPDE normal_NIG noise + NIG measurement noise

```{r case4, cache=TRUE}
normalnig_m_nig <- ngme(
  formula = Y ~ 1 +
    f(inla.group(seaDist), model = "rw1", noise = noise_normal()) +
    f(model = matern_spde, noise = noise_normal_nig()),
  data = list(
    Y = Y
  ),
  family = noise_nig(),
  control = control_opt(
    estimation = T,
    iterations = 1000,
    n_slope_check = 4,
    stop_points = 10,
    std_lim = 0.1,
    n_parallel_chain = 4,
    print_check_info = FALSE
  ),
  debug = FALSE,
  seed = 1000
)
normalnig_m_nig$latents[["field2"]]
traceplot(normalnig_m_nig, "field1")
traceplot(normalnig_m_nig, "field2")
range(Y)
plot(normalnig_m_nig$latents[["field2"]]$noise, xlim=c(-100, 100))
```

## case 5. RW1 + SPDE NIG noise + SPDE normal noise + normal measurement noise

```{r case5, cache=TRUE}
nig_normal_m_normal <- ngme(
  formula = Y ~ 1 +
    f(inla.group(seaDist), model = "rw1", noise = noise_normal()) +
    f(model = matern_spde, noise = noise_nig()) +
    f(model = matern_spde, noise = noise_normal()),
  data = list(
    Y = Y
  ),
  family = noise_nig(),
  control = control_opt(
    estimation = T,
    iterations = 1000,
    n_slope_check = 4,
    stop_points = 10,
    std_lim = 0.1,
    n_parallel_chain = 4,
    print_check_info = FALSE
  ),
  debug = FALSE,
  seed = 16
)

nig_normal_m_normal
traceplot(nig_normal_m_normal, 2)
traceplot(nig_normal_m_normal, 3)
```

## case 6. RW1 + SPDE NIG noise + SPDE normal noise + NIG measurement noise

```{r case6, cache=TRUE}
nig_normal_m_nig <- ngme(
  formula = Y ~ 1 +
    f(inla.group(seaDist), model = "rw1", noise = noise_normal()) +
    f(model = matern_spde, noise = noise_nig()) +
    f(model = matern_spde, noise = noise_normal()),
  data = list(
    Y = Y
  ),
  family = noise_nig(),
  control = control_opt(
    estimation = T,
    iterations = 1000,
    n_slope_check = 4,
    stop_points = 10,
    std_lim = 0.1,
    n_parallel_chain = 4,
    print_check_info = FALSE
  ),
  debug = FALSE,
  seed = 16
)

nig_normal_m_nig
traceplot(nig_normal_m_nig, param=2)
traceplot(nig_normal_m_nig, param=3)
```


## Results

Comparing the result of diffrerent fitting.

```{r}
# compare case 3456
all_cases <- list(
  normalnig_m_normal,
  normalnig_m_nig,
  nig_normal_m_normal,
  nig_normal_m_nig)

tog_cases <- list(normalnig_m_normal,normalnig_m_nig)
sep_cases <- list(nig_normal_m_normal, nig_normal_m_nig)

rw_sigma <- sapply(all_cases, function(x) x$latents[[1]]$noise$theta_sigma)
nig_kappa <- sapply(all_cases, function(x) x$latents[[2]]$theta_K)
nig_mu <- sapply(all_cases, function(x) x$latents[[2]]$noise$theta_mu)
nig_sigma <- sapply(all_cases, function(x) x$latents[[2]]$noise$theta_sigma)
nig_nu <- sapply(all_cases, function(x) x$latents[[2]]$noise$nu)

normal_kappa <- c(NA, NA, sapply(sep_cases, function(x) x$latents[[3]]$theta_K))
normal_sigma <- c(
  sapply(tog_cases, function(x) x$latents[[2]]$noise$theta_sigma_normal),
  sapply(sep_cases, function(x) x$latents[[3]]$noise$theta_sigma)
)

tt <- data.frame(rw_sigma, nig_kappa, nig_mu, nig_sigma, nig_nu, normal_kappa, normal_sigma)
rownames(tt) <- c("nornig + normal", "nornig + nig", "normal+nig + nomral", "normal+nig + nig")
format(tt, digits=3)

```

Some plots:

```{r}
# traceplot(normalnig_m_normal, param = 2)
# traceplot(normalnig_m_nig, param = 2)

# traceplot(nig_normal_m_normal, param = 2)
# traceplot(nig_normal_m_normal, param = 3)

# traceplot(nig_normal_m_nig, param = 2)
# traceplot(nig_normal_m_nig, param = 3)
```

## Now let's do prediction!

```{r}
seaDist.prd <- apply(spDists(coord.prd,
  PRborder[1034:1078, ],
  longlat = TRUE
), 1, min)
coord.prd.df$seaDist <- seaDist.prd


```

```{r}
model_pred <- nig_normal_m_normal

nxy <- c(150, 100)
projgrid <- inla.mesh.projector(
  prmesh,
  xlim = range(PRborder[, 1]),
  ylim = range(PRborder[, 2]),
  dims = nxy
)

xy.in <- inout(projgrid$lattice$loc, cbind(PRborder[, 1], PRborder[, 2]))

coord.prd <- projgrid$lattice$loc[xy.in, ]
plot(coord.prd, type = "p", cex = 0.1)
lines(PRborder)
points(coords[, 1], coords[, 2], pch = 19, cex = 0.5, col = "red")

coord.prd.df <- data.frame(x1 = coord.prd[,1],
                            x2 = coord.prd[,2])
coordinates(coord.prd.df) <- c("x1", "x2")

seaDist.prd <- apply(spDists(coord.prd,
  PRborder[1034:1078, ],
  longlat = TRUE
), 1, min)
coord.prd.df$seaDist <- seaDist.prd

preds <- predict(model_pred, data = NULL, loc = list(
  rw_loc = seaDist.prd,
  spde_loc = coord.prd.df,
  spde_loc = coord.prd.df
))

pred_df <- data.frame(
  x1 = coord.prd[, 1],
  x2 = coord.prd[, 2],
  preds = preds
)

ggplot(pred_df, aes(x = x1, y = x2, fill = preds)) +
  geom_raster() +
  scale_fill_viridis()
```