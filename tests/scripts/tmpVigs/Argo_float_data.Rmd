---
title: "Argo float data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Argo float data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(10)
```

In this vignette we will look into a spatial example of argo float data.

Load the libraries and read argo_float data:

```{r read-data}
library(INLA)
library(ggplot2)
library(viridis)
library(ngme2)
data(argo_float)
head(argo_float)
```

First we create using the mesh using INLA.

```{r create-mesh}
max.edge    <- 1
bound.outer <- 5
loc = unique(cbind(argo_float$lon, argo_float$lat))
# nrow(loc) == nrow(dat) no replicate

mesh <- inla.mesh.2d(loc=loc,
                    # the inner edge and outer edge
                    max.edge = c(1,5),
                    cutoff = 0.3,
                    # offset extension distance inner and outer extenstion
                    offset = c(max.edge, bound.outer)
)
plot(mesh); mesh$n
points(loc, col = "red")

fem_mesh = inla.mesh.fem(mesh)
Ce <- fem_mesh$c1 #<phi_i, phi_j>
C <- fem_mesh$c0 #approximation of Ce
G <- fem_mesh$g1
A <- inla.spde.make.A(mesh, loc) #dim(A) = data loc * vertices
```

Plot the data:

```{r plot-data}
ggplot(data=argo_float) +
  geom_point(aes(
    x = loc[, 1], y = loc[, 2],
    colour = temp
  ), size = 2, alpha = 1) +
  scale_color_gradientn(colours = viridis(100))

ggplot(data=argo_float) +
  geom_point(aes(
    x = loc[, 1], y = loc[, 2],
    colour = sal
  ), size = 2, alpha = 1) +
  scale_color_gradientn(colours = viridis(100))
```

Create a SPDE model using `model_matern`, fit the model:

```{r}
spde <- model_matern(
  loc = loc,
  mesh = mesh
)

out <- ngme(
  formula = temp ~ sal + f(model = spde, noise = noise_nig()),
  family = "nig",
  data = argo_float,
  seed = 7,
  control = control_opt(
    n_parallel_chain = 4,
    iterations = 20
  )
)
out
```


```{r}
plot(out$noise)
# beta merr
traceplot2(out, f_index = 0, param = "beta")
traceplot2(out, f_index = 0, param = "sigma")
traceplot2(out, f_index = 0, param = "mu")
traceplot2(out, f_index = 0, param = "nu")

# spde model
traceplot2(out, f_index = 1, param = "mu")
traceplot2(out, f_index = 1, param = "sigma")
traceplot2(out, f_index = 1, param = "nu")
```

