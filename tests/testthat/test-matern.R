# test spatial Matern model

# 1. test estimation of matern model
# 2. test predict(out, loc=new_loc)

test_that("test Matern", {
  library(INLA)
  pl01 <- cbind(c(0, 1, 1, 0, 0) * 10, c(0, 0, 1, 1, 0) * 5)
  mesh <- inla.mesh.2d(
    loc.domain = pl01, cutoff = 0.2,
    max.edge = c(0.5,10)
  )
# mesh$n
# plot(mesh)
  n_obs <- 500
  loc <- cbind(runif(n_obs, 0, 10), runif(n_obs, 0, 5))

  true_model <- model_matern(
    kappa = 3, mesh = mesh, map = loc, noise = noise_nig(
      mu=-2, sigma=1.5, nu=1, n = mesh$n
    )
  )
  W <- simulate(true_model)

  A <- inla.spde.make.A(loc=loc, mesh=mesh)
  Y <- as.numeric(A %*% W) + rnorm(n_obs, sd=0.5)

  # make bubble plot
  # sp_obj <- as.data.frame(mesh$loc); sp_obj[, 3] <- W
  # names(sp_obj) <- c("s1", "s2", "y")
  # coordinates(sp_obj) <- ~ s1 + s2
  # bubble(sp_obj, zcol=3)
  # range(mesh$loc[, 1]); range(mesh$loc[, 2])

# Matern case
  out <- ngme(
    Y ~ 0 + f(loc,
      model="matern",
      name="spde",
      mesh = mesh,
      noise=noise_nig(),
      control = control_f(numer_grad = F),
      # fix_theta_K = T, theta_kappa = log(3),
      # fix_W = TRUE,
      # W = W,
      debug = F
    ),
    data = data.frame(Y = Y),
    control_opt = control_opt(
      estimation = T,
      iterations = 100,
      n_parallel_chain = 4,
      print_check_info = F,
      verbose = F
    ),
    debug = F
  )
  # out[[1]]$latents[[1]]$noise$h == out[[1]]$latents[[1]]$h
  out
  traceplot(out)
  traceplot(out, "spde")
  plot(noise_nig(mu=-2,sigma=1.5,nu=1),
    out[[1]]$latents[[1]]$noise)

  # Now let's do some prediction
  new_xs <- c(3, 5, 7)
  new_ys <- c(3, 5, 3)
  coo <- matrix(c(new_xs, new_ys), ncol=2)
  predict(out, loc=list(coo))
  # plot(mesh)
  # points(x=new_xs, y = new_ys, type = "p", col="red", pch=16, cex=2)
  expect_true(TRUE)
})

# test more
test_that("test matern ns", {
  # library(devtools); library(INLA); load_all()
  { # First we create mesh
    pl01 <- cbind(c(0, 1, 1, 0, 0) * 10, c(0, 0, 1, 1, 0) * 5)
    mesh <- inla.mesh.2d(
      loc.domain = pl01,
      max.edge = 0.5
    )
    plot(mesh)

  n_obs <- 500; index_obs <- sample(1:mesh$n, n_obs)
  loc_obs <- mesh$loc[index_obs, c(1, 2)]
  A <- inla.spde.make.A(mesh = mesh, loc = loc_obs)
  sigma.e <- 0.7

  B_kappa <- matrix(c(rep(1, mesh$n), rexp(mesh$n)), ncol = 2)
  W <- simulate(model_matern(loc_obs,
      mesh = mesh,
      B_kappa = B_kappa,
      theta_kappa = c(1.1, 2)),
      noise = noise_nig())
  Y <- as.numeric(A %*% W) + sigma.e * rnorm(n_obs)
  points(loc_obs[,1], loc_obs[,2], col="red", pch=16, cex=2)
  }

  ngme_out <- ngme(
    Y ~ 0 + f(loc_obs,
      model="matern",
      mesh = mesh,
      theta_kappa = c(0.5, 0.5),
      B_kappa = B_kappa,
      fix_theta_K = FALSE,
      W = as.numeric(W),
      fix_W = TRUE,
      noise = noise_nig(),
      debug = F,
    ),
    data = data.frame(Y = Y),
    family = noise_normal(),
    control_opt = control_opt(
      estimation = T,
      iterations = 100,
      n_parallel_chain = 4
    ),
    debug = FALSE
  )
  ngme_out
  traceplot(ngme_out, "field1")

  expect_true(TRUE)
})

##################################################
test_that("test 1d matern with numerical g", {
  library(INLA)
  n_mesh <<- 800
  mesh <- inla.mesh.1d(1:n_mesh)
  n_obs <<- 500
  loc <- runif(n_obs, 1, n_mesh)
  real_noise <- noise_nig(mu = -5, sigma=3, nu=2, n=n_mesh)
  spde1d <- model_matern(map = loc, mesh=mesh, kappa=2,
    noise = noise_nig(mu = -5, sigma=3, nu=2, n=n_mesh))
# spde1d$noise$h

# simulate
  # W <- simulate(spde1d)
  eps <- simulate.ngme_noise(real_noise)
  K <- 4 * spde1d$C + spde1d$G
  W <- as.numeric(solve(K, eps))
  Y <- as.numeric(spde1d$A %*% W) + rnorm(n_obs, sd=0.5)
# plot(Y, type="l")

  out <- ngme(
    Y ~ 0 + f(loc, model="matern", mesh=mesh, noise=noise_nig(),
      # fix_W = T, W =W
    ),
    data = data.frame(Y = Y),
    control_opt = control_opt(
      estimation = F,
      iterations = 100,
      n_parallel_chain = 4
    )
  )
  out
# traceplot(out, "field1")
# plot(out[[1]]$latents[[1]]$noise, real_noise)

  expect_true(TRUE)
})
